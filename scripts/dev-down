#!/usr/bin/env pwsh
$ErrorActionPreference = 'Stop'

$repoRoot = Resolve-Path (Join-Path $PSScriptRoot '..')
$stateFile = Join-Path $repoRoot '.dev' 'pids.json'
$valhallaCompose = Join-Path $repoRoot 'infra' 'valhalla.compose.yml'

if (-not (Test-Path $stateFile)) {
    Write-Host 'Aucun processus à arrêter.'
} else {
    $pids = Get-Content -Path $stateFile | ConvertFrom-Json

    foreach ($entry in $pids.PSObject.Properties) {
        $pid = [int]$entry.Value
        try {
            Stop-Process -Id $pid -Force -ErrorAction Stop
            Write-Host "Processus arrêté: $pid"
        } catch {
            Write-Host "Processus déjà arrêté: $pid"
        }
    }

    Remove-Item -Path $stateFile -Force
}

$knownProcessNames = @('BikeVoyager.AppHost', 'BikeVoyager.Api')
foreach ($processName in $knownProcessNames) {
    $running = Get-Process -Name $processName -ErrorAction SilentlyContinue
    foreach ($process in $running) {
        try {
            Stop-Process -Id $process.Id -Force -ErrorAction Stop
            Write-Host "Processus arrêté (fallback): $($process.ProcessName)#$($process.Id)"
        }
        catch {
            Write-Host "Processus déjà arrêté (fallback): $($process.ProcessName)#$($process.Id)"
        }
    }
}

try {
    docker compose -f $valhallaCompose stop valhalla | Out-Null
} catch {
    Write-Host "Valhalla: arret ignore (Docker indisponible ?)."
}
